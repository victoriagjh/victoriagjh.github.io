---
title:  "ê²¬ê³ í•œ node.js ì•„í‚¤í…ì³ ì„¤ê³„í•˜ê¸°"
date: 2020-03-02 20:00:00
description: The history of Development Study
categories: [devKnowledge]
resource: true
comments: true
---
# ê²¬ê³ í•œ node.js ì•„í‚¤í…ì³
### `í´ë” êµ¬ì¡°` 
- app.js : ì•±ì˜ ì§„ì… í¬ì¸íŠ¸
- api : ì•±ì˜ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ë¥¼ ìœ„í•œ ë¼ìš°íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬(endpoint : ìµœì¢… ëª©ì ì§€)
- config : configurationê³¼ ê´€ë ¨ëœ ê²ƒë“¤ê³¼ í™˜ê²½ ë³€ìˆ˜ë“¤
- jobs : agenda.jsì— ëŒ€í•œ ì‘ì—… ì •ì˜ // cronjobì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë…¸ë“œ ëª¨ë“ˆ
- loaders : ì‹œì‘ í”„ë¡œì„¸ìŠ¤ë¥¼ ëª¨ë“ˆë¡œ ë¶„í• 
- models : ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸
- services : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ëª¨ë‘ ì—¬ê¸°!
- subscribers : ë¹„ë™ê¸° í…ŒìŠ¤í¬ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
- types : íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìœ„í•œ íƒ€ì… ì •ì˜ íŒŒì¼ë“¤

### `3 ê³„ì¸µ ì„¤ê³„ - 3 Layer Architecture`
##### ê´€ì‹¬ì‚¬ ë¶„ë¦¬ ì›ì¹™ì„ ì ìš©í•˜ê¸° ìœ„í•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ node.jsì˜ API Routesì™€ ë¶„ë¦¬í•´ì¤€ë‹¤.  <br>
> ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ : ë°ì´í„°ë¥¼ ìƒì„±*í‘œì‹œ*ì €ì¥*ë³€ê²½ í•˜ëŠ” íŒŒíŠ¸ë¥¼ ì¼ì»«ëŠ”ë‹¤ <br>

ğŸ‘‰ ì–¸ì  ê°€ ë°˜ë³µë˜ëŠ” ì‘ì—…ì„ í•˜ë‹¤ë³´ë©´ CLI ë„êµ¬ë¥¼ í†µí•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‚¬ìš©í•˜ê³  ì‹¶ì–´ì§ˆ ê²ƒì„. <br>
ğŸ‘‰ node.js serverì—ì„œ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì€ ìƒê°ì€ ì•„ë‹ˆë‹¤. <br>

##### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ controllerì— ë„£ì§€ ë§ˆì„¸ìš”!!<br/>
ğŸ‘‰ ìŠ¤íŒŒê²Œí‹° ì½”ë“œê°€ ë˜ì–´ë²„ë¦´ ê²ƒì´ë‹¤.<br/>

{% highlight javascript %}
route.post('/', async (req, res, next) => {

  // This should be a middleware or should be handled by a library like Joi.
  const userDTO = req.body;
  const isUserValid = validators.user(userDTO)
  if(!isUserValid) {
    return res.status(400).end();
  }

  // Lot of business logic here...
  const userRecord = await UserModel.create(userDTO);
  delete userRecord.password;
  delete userRecord.salt;
  const companyRecord = await CompanyModel.create(userRecord);
  const companyDashboard = await CompanyDashboard.create(userRecord, companyRecord);

  ...whatever...


  // And here is the 'optimization' that mess up everything.
  // The response is sent to client...
  res.json({ user: userRecord, company: companyRecord });

  // But code execution continues :(
  const salaryRecord = await SalaryModel.create(userRecord, companyRecord);
  eventTracker.track('user_signup',userRecord,companyRecord,salaryRecord);
  intercom.createUser(userRecord);
  gaAnalytics.event('user_signup',userRecord);
  await EmailService.startSignupSequence(userRecord)
});
{% endhighlight %}
- ì´ ì½”ë“œì˜ ë¬¸ì œì  
1. ì¤‘ê°„ì— ë§ì€ business ë¡œì§ì´ ì¡´ì¬í•œë‹¤. 
2. res.json()ì— ë³µì¡í•œ ê²ƒë“¤ì˜ ìµœì¢…ì ì¸ ê²ƒì„ ë‹´ì•„ì„œ responseë¡œ ë§Œë“ ë‹¤.
3. í•˜ì§€ë§Œ ì´ ì´í›„ì—ë„ ë‹¤ë¥¸ ì½”ë“œì˜ executionì´ ì¼ì–´ë‚œë‹¤.

##### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ service ê³„ì¸µì— ìˆì–´ì•¼ í•œë‹¤. <br/>
Service Layer(API ê¼ì¸µ)ì— SQL queryì˜ í˜•íƒœì˜ ì½”ë“œê°€ ìˆì–´ì„œëŠ” ì•ˆëœë‹¤. ì´ëŠ” Data Access Layerê³„ì¸µì— ìˆì–´ì•¼ í•œë‹¤.

- í•´ë‹¹ ì½”ë“œë¥¼ routerì—ì„œ ë¶„ë¦¬í•˜ê¸°
- service ë ˆì´ì–´ì—ëŠ” reqì™€ res ê°ì²´ë¥¼ ì „ë‹¬í•˜ì§€ ë§ê¸°
- ìƒíƒœ ì½”ë“œ ë˜ëŠ” í—¤ë”ì™€ ê°™ì€ HTTP ì „ì†¡ ê³„ì¸µê³¼ ê´€ë ¨ëœ ê²ƒë“¤ì€ ë°˜í™˜í•˜ì§€ ë§ê¸°

{% highlight javascript %}

route.post('/', 
  validators.userSignup, // this middleware take care of validation
  async (req, res, next) => {
    // The actual responsability of the route layer.
    const userDTO = req.body;

    // Call to service layer.
    // Abstraction on how to access the data layer and the business logic.
    const { user, company } = await UserService.Signup(userDTO);

    // Return a response to client.
    return res.json({ user, company });
  });

{% endhighlight %}
**User Serviceë¥¼ í˜¸ì¶œí•¨** <br/>
{% highlight javascript %}
export default class UserService() {

  async Signup(user) {
    const userRecord = await UserModel.create(user);
    const companyRecord = await CompanyModel.create(userRecord); // needs userRecord to have the database id 
    const salaryRecord = await SalaryModel.create(userRecord, companyRecord); // depends on user and company to be created
    
    ...whatever
    
    await EmailService.startSignupSequence(userRecord)

    ...do more stuff

    return { user: userRecord, company: companyRecord };
  }
}
{% endhighlight %}

ğŸ‘‰ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ Service Layerì— ìº¡ìŠí™”!

##### ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì—ëŠ” Pub/Sub ê³„ì¸µë„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤ with Event<br/>
- ì „í˜•ì ì¸ 3ê³„ì¸µ êµ¬ì¡° ë²”ìœ„ë¥¼ ë„˜ì–´ì„œì§€ë§Œ ë§¤ìš° ìœ ìš©í•¨.
IF, ê°„ë‹¨í•œ node.js API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ìœ ì €ë¥¼ ìƒì„±í•œ ì´í›„, third-party (ì œ 3ì)ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜ ì„œë¹„ìŠ¤ ë¶„ì„ì„ ì‹œë„í•˜ê±°ë‚˜, ì´ë©”ì¼ ì „ì†¡ê³¼ ê°™ì€ ì‘ì—…ì„ í•˜ê³  ì‹¶ë‹¤? <br/>
ğŸ‘‰ createë¼ëŠ” ì‘ì—…ì´ ì—¬ëŸ¬ ì¼ì„ í•˜ê²Œ ë  ê²ƒì´ê³ , í•˜ë‚˜ì˜ í•¨ìˆ˜ì•ˆì— 1000ì¤„ì´ ë„˜ì–´ê°€ëŠ” ì½”ë“œê°€ ìƒê¸¸ ê²ƒ <br/>
ì´ëŠ” **ë‹¨ì¼ ì±…ì„ ì›ì¹™**ì„ ìœ„ë°°í•œë‹¤! <br/>
ğŸ‘‰ í•´ë‹¹ ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ì—¬ ê°„ê²°í•˜ê²Œ ì½”ë“œë¥¼ ìœ ì§€(í•¨ìˆ˜ë¡œ ë¹¼ë‚´ê¸°) <br/>
ğŸ‘‰ **ë…ë¦½ì ì¸ ì„œë¹„ìŠ¤ë“¤ì„ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ìµœì„ ì˜ ë°©ë²•ì´ ì•„ë‹ˆë‹¤!** <br/>
ğŸ‘‰ **ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ ë¦¬ìŠ¤ë„ˆë“¤ì´ í•´ë‹¹ ì¼ì„ í•˜ë„ë¡ í•œë‹¤!** <br/>

##### ì˜ì¡´ì„± ì£¼ì…
ì˜ì¡´ì„± ì£¼ì…(D.I), ì œì–´ ì—­ì „ì€ ì½”ë“œë¥¼ êµ¬ì¡°í™”í•˜ëŠ”ë° ë§ì´ ì‚¬ìš©ë˜ëŠ” íŒ¨í„´ì´ë‹¤. ìƒì„±ìë¥¼ í†µí•´ í´ë˜ìŠ¤ì™€ í•¨ìˆ˜ì˜ ì˜ì¡´ì„±ì„ ì „ë‹¬í•´ì£¼ëŠ” ë°©ì‹ì´ë‹¤. <br/>
ğŸ‘‰ **í˜¸í™˜ê°€ëŠ¥í•œ ì˜ì¡´ì„±** ì„ ì£¼ì…í•¨ìœ¼ë¡œì¨ ìœ ì—°í•˜ê²Œ ì½”ë“œë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë‹¤. <br/>
(ì–´ë– í•œ ìƒì„±ìë‚´ì— í´ë˜ìŠ¤ë¥¼ ì „ë‹¬í•¨ìœ¼ë¡œì¨ ì˜ì¡´ì„±ì„ ë†’ì´ëŠ” ë°©ì‹)
ğŸ‘‰ ì„œë¹„ìŠ¤ê°€ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ì¢…ì†ì„±ì˜ ì–‘ì€ ë¬´í•œí•˜ê³ , ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¶”ê°€í•  ë•Œ ì„œë¹„ìŠ¤ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤í™”ë¥¼ ë¦¬íŒ©í„°ë§í•˜ëŠ” ê²ƒì€ ì§€ë£¨í•˜ê³  ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê¸° ì‰¬ìš´ ì‘ì—…ì´ë‹¤(ê° ê°ì²´ê°„ ì˜ì¡´ì„±ì´ ë†’ê¸° ë•Œë¬¸)
##### ì˜ì¡´ì„± ì£¼ì… í”„ë ˆì„ì›Œí¬ì˜ ë“±ì¥
- í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•  ë•Œ, Service Locatorë¥¼ í˜¸ì¶œí•˜ë©´ ë¨.

##### Unit Test
ğŸ‘‰ req/res ê°ì²´ë“¤ê³¼ requireì˜ í˜¸ì¶œì—†ì´ í•´ë‹¹ service ë ˆì´ì–´ì˜ í•¨ìˆ˜ë§Œìœ¼ë¡œ ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>

##### ìŠ¤ì¼€ì¤„ë§ ë° ë°˜ë³µì‘ì—…
node.jsì˜ task managerëŠ” agenda.jsë¥¼ ì´ìš©í•´ì„œ ê°€ëŠ¥í•¨

##### ì„¤ì • ë° ì‹œí¬ë¦¿ íŒŒì¼ with configuration manager(dotenv) 
API Keyì™€ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ê³¼ ê´€ë ¨ëœ ì„¤ì •ì„ ì €ì¥í•˜ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ì‹ì€ dotenvë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.
ğŸ‘‰ dotenvëŠ” .envíŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ì•ˆì— ìˆëŠ” ê°’ë“¤ì„ node.jsì˜ process.env ê°ì²´ì— ëŒ€ì…í•œë‹¤.
ğŸ‘‰ ì¶”ê°€ì ìœ¼ë¡œ, config/index.jx íŒŒì¼ì—ì„œ npm íŒ¨í‚¤ì§€ dotenvê°€ .envíŒŒì¼ì„ ë¡œë“œí•˜ê³ , ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ë¥¼ ìì •í•œë‹¤.

{% highlight javascript %}
const dotenv = require('dotenv');
// config() will read your .env file, parse the contents, assign it to process.env.
dotenv.config();

export default {
  port: process.env.PORT,
  databaseURL: process.env.DATABASE_URI,
  paypal: {
    publicKey: process.env.PAYPAL_PUBLIC_KEY,
    secretKey: process.env.PAYPAL_SECRET_KEY,
  },
  paypal: {
    publicKey: process.env.PAYPAL_PUBLIC_KEY,
    secretKey: process.env.PAYPAL_SECRET_KEY,
  },
  mailchimp: {
    apiKey: process.env.MAILCHIMP_API_KEY,
    sender: process.env.MAILCHIMP_SENDER,
  }
}
{% endhighlight %}

### ì˜ ì´í•´ê°€ ì•ˆê°€ë„¤?
- Serviceì—ì„œ model.createí•˜ë©´ ì´ê²Œ data line ê³„ì¸µ ì•„ë‹Œê°€..??
- ì˜ì¡´ì„± ì£¼ì…ì€ ì˜ ëª¨ë¥´ê²ŸìŒ. ë” ê³µë¶€í•´ì•¼ê² ë‹¤

### ì ìš©í•˜ë©´ ì¢‹ì„ ì‚¬í•­
- dotenvë¥¼ ì´ìš©í•´ envíŒŒì¼ì•ˆì— ë°ì´í„°ë¥¼ ë¡œë“œí•´ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
- layerë¥¼ ë‚˜ëˆ„ì–´ service layerê³„ì¸µìœ¼ë¡œ í˜„ì¬ APIë“¤ì„ ë¹¼ë‚´ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒ ğŸ‘‰ ì´ë ‡ê²Œ ë°”ê¾¸ë©´ ë‚˜ì¤‘ì— í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ìˆ˜ì›”í•˜ê²Œ ì‘ì„±í•  ìˆ˜ ìˆì„ ê²ƒ 
- ì´ì „ì— isNew/isUpê³¼ ê´€ë ¨í–ˆë˜ ì´ìŠˆë¥¼ agenda.jsë¥¼ ì´ìš©í•´ì„œ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì—ˆì„ ë“¯ (í•˜ì§€ë§Œ ì´ ì—­ì‹œ ì–´ë–»ê²Œ ì²´í¬í• ì§€ í•¸ë“¤ë§í•˜ëŠ” ì´ìŠˆê°€ ìˆì—ˆê²Ÿì§€?)
- ë‹¤ë¥¸ ì½”ë“œëŠ” í•¨ìˆ˜í™” í•´ì„œ ì´ë²¤íŠ¸ë¡œ ê´€ë¦¬í•˜ëŠ” ê²Œ ì¢‹ì„ë“¯ (ì´ëŸ° ì‘ì—…ì„ ì“°ëŠ”ê²Œ ê±°ì˜ ì—†ì„ë“¯)


### `ì°¸ê³ ìë£Œ`
ê²¬ê³ í•œ node.js ì„¤ê³„í•˜ê¸° : [hopsprings](https://velog.io/@hopsprings2/%EA%B2%AC%EA%B3%A0%ED%95%9C-node.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90-%EC%84%A4%EA%B3%84%ED%95%98%EA%B8%B0)  <br>
